name: 'Deploy Noble LTS to latest version'

on:
  push:
    branches: [ main ]

env:
  version: v1.0.2

jobs:
  get-short-sha:
    runs-on: ubuntu-latest
    outputs: 
      short-sha: ${{ steps.sha.outputs.short-sha }}
    steps:
      - name: Get SHA7
        id: sha
        uses: concordia-fsae/firmware/.github/actions/pull/@master
        with:
          ref: ${{ github.event.pull_request.head.sha }}
      - name: Print branch information
        run: |
          echo "Merge branch: ${{ github.head_ref }}" && \
          echo "Current SHA: ${{ github.sha }}" && \
          echo "PR head: ${{ github.event.pull_request.head.ref }}" && \
          echo "PR head SHA: ${{ github.event.pull_request.head.sha }}" && \
          echo "PR head SHA7: ${{ steps.sha.outputs.short-sha }}" && \
          echo "PR base head: ${{ github.event.pull_request.head.ref }}" && \
          echo "PR base head SHA: ${{ github.event.pull_request.head.sha }}"
  retag-latest:
    runs-on: ubuntu-latest
    needs: get-short-sha
    steps:
      - name: Retag
        uses: concordia-fsae/containers/.github/actions/retag_push_image/@master
        with:
          container: ubuntu-noble-lts
          tag-input: ${{ needs.get-short-sha.outputs.short-sha }}
          tag-output: latest
          token: ${{ secrets.GITHUB_TOKEN }}
  retag-version:
    runs-on: ubuntu-latest
    needs: get-short-sha
    steps:
      - name: Retag
        uses: concordia-fsae/containers/.github/actions/retag_push_image/@master
        with:
          container: ubuntu-noble-lts
          tag-input: ${{ needs.get-short-sha.outputs.short-sha }}
          tag-output: ${{ env.version }}
          token: ${{ secrets.GITHUB_TOKEN }}
  build-multiarch-manifest-latest:
    runs-on: ubuntu-latest
    needs: retag-latest
    steps:
      - name: Build Multiarch SHA Manifest
        uses: concordia-fsae/containers/.github/actions/create_multiarch_manifest/@master
        with:
          container: ubuntu-noble-lts
          tag: latest
          token: ${{ secrets.GITHUB_TOKEN }}
  build-multiarch-manifest-version:
    runs-on: ubuntu-latest
    needs: retag-version
    steps:
      - name: Build Multiarch SHA Manifest
        uses: concordia-fsae/containers/.github/actions/create_multiarch_manifest/@master
        with:
          container: ubuntu-noble-lts
          tag: ${{ env.version }}
          token: ${{ secrets.GITHUB_TOKEN }}
